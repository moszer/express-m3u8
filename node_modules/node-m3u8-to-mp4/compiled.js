"use strict";function _createForOfIteratorHelper(e,t){var r,n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,t=function(){};return{s:t,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:(r=function(e){throw e},o.toString=function(){return r.toString()},o),f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(e){return r.apply(this,arguments)}var c,s,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:(s=function(e){u=!0,c=e},f.toString=function(){return s.toString()},f),f:function(){try{i||null==n.return||n.return()}finally{if(u)throw c}}};function f(e){return s.apply(this,arguments)}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function asyncGeneratorStep(e,t,r,n,a,o,c){try{var s=e[o](c),i=s.value}catch(e){return void r(e)}s.done?t(i):Promise.resolve(i).then(n,a)}function _asyncToGenerator(s){return function(){var e=this,c=arguments;return new Promise(function(t,r){var n=s.apply(e,c);function a(e){asyncGeneratorStep(n,t,r,a,o,"next",e)}function o(e){asyncGeneratorStep(n,t,r,a,o,"throw",e)}a(void 0)})}}require("babel-polyfill");var fs=require("fs"),fse=require("fs-extra"),path=require("path"),https=require("https"),axios=require("axios"),targetPath=path.resolve(".tmp"),isRemoteReg=/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/,hostReg=/^(http|ftp|https):\/\/((?!\/).)*/,m3u8Reg=/\.m3u8$/,timeout=3e4,onDownloading=function(){},onCombining=function(){},parseRemote=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function t(r,n){var a,o,c,s,i,u,f,p,l;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=r.split("/").slice(0,-1).join("/"),o=r.match(hostReg)[0],t.next=5,axios.get(r,{headers:n,timeout:timeout,httpsAgent:new https.Agent({rejectUnauthorized:!1,agent:!1})});case 5:if(s=t.sent,c=s.status,s=s.data,200!==c){t.next=41;break}i=[],f=s.split("\n").filter(function(e){return 0<e.replace(/\s*/g,"").length&&!e.startsWith("#")}),u=_createForOfIteratorHelper(f),t.prev=12,u.s();case 14:if((f=u.n()).done){t.next=30;break}if(f=f.value,p="",l=isRemoteReg.test(f),p=l?f:(f.startsWith("/")?"".concat(o):"".concat(a,"/")).concat(f),m3u8Reg.test(f))return t.t0=i,t.next=23,parseRemote(p,n);t.next=27;break;case 23:t.t1=t.sent,i=t.t0.concat.call(t.t0,t.t1),t.next=28;break;case 27:i.push({url:p,isFull:l});case 28:t.next=14;break;case 30:t.next=35;break;case 32:t.prev=32,t.t2=t.catch(12),u.e(t.t2);case 35:return t.prev=35,u.f(),t.finish(35);case 38:return t.abrupt("return",i);case 41:throw e;case 42:t.next=47;break;case 44:throw t.prev=44,t.t3=t.catch(0),t.t3;case 47:case"end":return t.stop()}},t,this,[[0,44],[12,32,35,38]])}));return function(e,t){return r.apply(this,arguments)}}(),parseLocal=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,a,o,c,s,i,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=t.split("/").slice(0,-1).join("/"),a=[],o=fs.readFileSync(t,"utf-8"),c=o.split("\n").filter(function(e){return 0<e.replace(/\s*/g,"").length&&!e.startsWith("#")}),o=_createForOfIteratorHelper(c),e.prev=6,o.s();case 8:if((c=o.n()).done){e.next=31;break}if(s=c.value,i=isRemoteReg.test(s))return e.t0=a,e.next=15,parseRemote(s,r);e.next=19;break;case 15:e.t1=e.sent,a=e.t0.concat.call(e.t0,e.t1),e.next=29;break;case 19:if(u="".concat(n,"/").concat(s),m3u8Reg.test(s))return e.t2=a,e.next=24,parseLocal(u,r);e.next=28;break;case 24:e.t3=e.sent,a=e.t2.concat.call(e.t2,e.t3),e.next=29;break;case 28:a.push({url:u,isFull:i});case 29:e.next=8;break;case 31:e.next=36;break;case 33:e.prev=33,e.t4=e.catch(6),o.e(e.t4);case 36:return e.prev=36,o.f(),e.finish(36);case 39:return e.abrupt("return",a);case 42:throw e.prev=42,e.t5=e.catch(0),e.t5;case 45:case"end":return e.stop()}},e,this,[[0,42],[6,33,36,39]])}));return function(e,t){return r.apply(this,arguments)}}(),compare=function t(r,n,a,o){var c=setTimeout(function(){if(!(Date.now()-r>timeout))return clearTimeout(c),t(r,n,a,o);if(fs.existsSync(n)){var e=fs.statSync(n);if(a<e.size)return clearTimeout(c),t(r,n,e.size,o)}clearTimeout(c),o()},3e3)},streamToBuffer=function(a){return new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{n=[],a.on("data",function(e){n.push(e)}),a.on("error",function(e){r(e)}),a.on("end",function(){t(Buffer.concat(n))})}catch(e){r(e)}case 1:case"end":return e.stop()}},e,this)}));return function(e,t){return r.apply(this,arguments)}}())},downloadTsItem=function u(f,p,l){var h=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};return new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,a,o,c,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=fs.createWriteStream("".concat(l,"/").concat(p,".ts"),{emitClose:!0}),e.next=4,axios.get(f,{timeout:timeout,responseType:"stream",httpsAgent:new https.Agent({rejectUnauthorized:!1,agent:!1}),headers:h});case 4:if(a=e.sent,i=a.status,o=a.data,200!==i){e.next=17;break}s=c=!1,i=Date.now(),n.on("close",function(){s||(c=!0,o.destroy(),n.destroy(),t())}),o.pipe(n),compare(i,"".concat(l,"/").concat(p,".ts"),0,function(){c||(s=!0,o.destroy(),n.destroy(),u(f,p,l,h).then(function(){return t()}))}),e.next=18;break;case 17:throw new Error("网络错误");case 18:e.next=24;break;case 20:e.prev=20,e.t0=e.catch(0),u(f,p,l,h).then(function(){return t()}),r(e.t0);case 24:case"end":return e.stop()}},e,this,[[0,20]])}));return function(e,t){return r.apply(this,arguments)}}())},mParser=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=1<a.length&&void 0!==a[1]?a[1]:{},e.prev=1,n=[],isRemoteReg.test(t))return e.next=6,parseRemote(t,r);e.next=9;break;case 6:n=e.sent,e.next=12;break;case 9:return e.next=11,parseLocal(t,r);case 11:n=e.sent;case 12:return e.abrupt("return",n);case 15:throw e.prev=15,e.t0=e.catch(1),e.t0;case 18:case"end":return e.stop()}},e,this,[[1,15]])}));return function(e){return t.apply(this,arguments)}}(),mDownloader=function(c,e){var t=e.targetPath,s=void 0===t?s:t,e=e.headers,i=void 0===e?{}:e;return new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(o,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.delegateYield(regeneratorRuntime.mark(function e(){var t,r,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:fs.existsSync(s)||fs.mkdirSync(s),t=c.reduce(function(e,t,r){return r%10==0?e.push([t]):e[Math.floor(r/10)].push(t),e},[]),onDownloading(r=0,t.length),n=_createForOfIteratorHelper(t),e.prev=5,n.s();case 7:if((a=n.n()).done){e.next=15;break}return a=a.value,++r,e.next=12,Promise.all(a.map(function(e,t){return downloadTsItem(e,10*(r-1)+t,s,i)}));case 12:onDownloading(r,t.length);case 13:e.next=7;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(5),n.e(e.t0);case 20:return e.prev=20,n.f(),e.finish(20);case 23:o();case 24:case"end":return e.stop()}},e,this,[[5,17,20,23]])})(),"t0",2);case 2:e.next=7;break;case 4:e.prev=4,e.t1=e.catch(0),t(e.t1);case 7:return e.abrupt("return",!0);case 8:case"end":return e.stop()}},e,this,[[0,4]])}));return function(e,t){return r.apply(this,arguments)}}())},mConverter=function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(i,u){var f,t=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return f=!(2<t.length&&void 0!==t[2])||t[2],e.abrupt("return",new Promise(function(){var r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n,a,o,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=fs.readdirSync(i).sort(function(e,t){return parseInt(e)-parseInt(t)}),a=0,o=_createForOfIteratorHelper(n),e.prev=4,o.s();case 6:if((c=o.n()).done){e.next=16;break}return s=c.value,onCombining(++a,n.length),e.next=12,streamToBuffer(fs.createReadStream("".concat(i,"/").concat(s)));case 12:s=e.sent,fs.appendFileSync(u,s);case 14:e.next=6;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(4),o.e(e.t0);case 21:return e.prev=21,o.f(),e.finish(21);case 24:f&&fse.removeSync(i),t(),e.next=32;break;case 28:e.prev=28,e.t1=e.catch(0),f&&fse.removeSync(i),r(e.t1);case 32:case"end":return e.stop()}},e,this,[[0,28],[4,18,21,24]])}));return function(e,t){return r.apply(this,arguments)}}()));case 2:case"end":return e.stop()}},e,this)}));return function(e,t){return r.apply(this,arguments)}}(),mIndicator=function(e,t){switch(e){case"downloading":onDownloading=t;break;case"converting":onCombining=t}};module.exports={mParser:mParser,mDownloader:mDownloader,mConverter:mConverter,mIndicator:mIndicator};